import asyncio
import json
import math
import time
from typing import List, Optional, Sequence, Tuple

import websockets

HOST = "0.0.0.0"
PORT = 18000

# Map bounds from realtime server (world -> UI map normalization)
X_MIN, X_MAX = -25.72432848384547, 25.744828483845467
Y_MIN, Y_MAX = -18.432071780223303, 19.171471780223307


def world_to_map_xy(cx: float, cy: float) -> Tuple[float, float]:
    def _norm(v: float, vmin: float, vmax: float) -> float:
        if vmax <= vmin:
            return 0.5
        t = (v - vmin) / (vmax - vmin)
        return max(0.0, min(1.0, t))

    u = _norm(cx, X_MIN, X_MAX)
    v = 1.0 - _norm(cy, Y_MIN, Y_MAX)
    return float(u), float(v)


def normalize_route(points: Sequence[Sequence[float]]) -> List[dict]:
    normalized: List[dict] = []
    for pt in points:
        try:
            px, py = float(pt[0]), float(pt[1])
        except Exception:
            continue
        try:
            x_map, y_map = world_to_map_xy(px, -py)
        except Exception:
            continue
        normalized.append({"x": x_map, "y": y_map})
    return normalized


def sample_route(route: List[dict], t: float) -> Tuple[float, float, float]:
    if not route:
        return 0.5, 0.5, 0.0
    idx = int(t) % len(route)
    a = route[idx]
    b = route[(idx + 1) % len(route)]
    dx = float(b["x"]) - float(a["x"])
    dy = float(b["y"]) - float(a["y"])
    yaw = math.degrees(math.atan2(dy, dx)) if dx or dy else 0.0
    return float(a["x"]), float(a["y"]), yaw


PATH_MAIN_WORLD = json.loads(
    """
[
  [-21.4983539581299, 2.85270094871521],
  [-22.1793670654297, 4.00882339477539],
  [-22.6528072357178, 5.26431083679199],
  [-22.9047546386719, 6.58223438262939],
  [-22.927791595459, 7.92382574081421],
  [-22.6498146057129, 9.51999759674072],
  [-22.2183303833008, 10.7199201583862],
  [-21.6257915496826, 11.8490304946899],
  [-20.8834819793701, 12.885838508606],
  [-20.0474872589111, 13.7788000106812],
  [-19.0869464874268, 14.593409538269],
  [-18.0287895202637, 15.2764415740967],
  [-16.890926361084, 15.8163433074951],
  [-15.6926050186157, 16.2039737701416],
  [-14.4541082382202, 16.4327774047852],
  [-13.2215356826782, 16.4996490478516],
  [-12.2215366363525, 16.4996490478516],
  [-11.2215366363525, 16.4996490478516],
  [-10.2215366363525, 16.4996490478516],
  [-9.22153854370117, 16.4996490478516],
  [-8.22153854370117, 16.4996490478516],
  [-7.22153759002686, 16.4996490478516],
  [-6.22153759002686, 16.4996490478516],
  [-5.22153759002686, 16.4996490478516],
  [-4.22153759002686, 16.4996490478516],
  [-3.22153759002686, 16.4996490478516],
  [-2.22153759002686, 16.4996490478516],
  [-1.22153759002686, 16.4996490478516],
  [-0.221538543701172, 16.4996490478516],
  [0.778461456298828, 16.4996490478516],
  [1.77846050262451, 16.4996490478516],
  [2.7784595489502, 16.4996490478516],
  [3.7784595489502, 16.4996490478516],
  [4.7784595489502, 16.4996490478516],
  [5.77845764160156, 16.4996490478516],
  [6.7784595489502, 16.4996490478516],
  [7.77845764160156, 16.4996490478516],
  [8.7784595489502, 16.4996490478516],
  [9.7784595489502, 16.4996490478516],
  [10.7784595489502, 16.4996490478516],
  [11.7784557342529, 16.4996490478516],
  [12.7784576416016, 16.4996490478516],
  [13.8979587554932, 16.482271194458],
  [15.1475868225098, 16.3252410888672],
  [16.3662586212158, 16.0073280334473],
  [17.533353805542, 15.5339164733887],
  [18.6291217803955, 14.9130153656006],
  [19.6350250244141, 14.1551294326782],
  [20.5102863311768, 13.3104991912842],
  [21.3145980834961, 12.3210163116455],
  [21.975061416626, 11.23024559021],
  [22.6497974395752, 9.52005863189697]
]
"""
)

PATH_DETOUR_WORLD = json.loads(
    """
[
  [20.0305366516113, -13.7953281402588],
  [19.0680389404297, -14.607629776001],
  [18.0082378387451, -15.2881183624268],
  [16.8690757751465, -15.8252801895142],
  [15.6698207855225, -16.2100257873535],
  [14.4307699203491, -16.4358425140381],
  [13.2028665542603, -16.5],
  [12.2028656005859, -16.5],
  [11.2028656005859, -16.5],
  [10.2028636932373, -16.5],
  [9.20286560058594, -16.5],
  [8.00256252288818, -16.5],
  [6.87770843505859, -16.4794311523438],
  [5.65188217163086, -16.3296871185303],
  [4.45215845108032, -16.0368804931641],
  [3.29517316818237, -15.6050710678101],
  [2.19697141647339, -15.0402479171753],
  [1.17278075218201, -14.3502416610718],
  [0.188729166984558, -13.46812915802],
  [-0.642558455467224, -12.4279308319092],
  [-1.28989779949188, -11.2643146514893],
  [-1.73537385463715, -10.0094833374023],
  [-1.96665859222412, -8.69816398620606],
  [-2, -7.5],
  [-2.01810765266418, -6.49989366531372],
  [-2, -7],
  [-2.06727695465088, -5.98069381713867],
  [-2.2255802154541, -4.92360067367554],
  [-2.44925999641418, -3.75851392745972],
  [-2.64642834663391, -2.82742857933044],
  [-2.94104409217834, -2.39444136619568],
  [-3.08729147911072, -2.23133444786072],
  [-3.5396089553833, -1.79782390594482],
  [-4.37607145309448, -0.0488084554672241],
  [-3.24645185470581, 4.11617565155029],
  [2.24979114532471, 4.89723491668701],
  [4.49497747421265, 1.21254634857178],
  [3.65886425971985, -1.63309216499329],
  [-2.40258502960205, -2.80733585357666],
  [-3.87842893600464, -1.28215742111206],
  [-2.25041341781616, 4.89687538146973],
  [-0.000714155961759388, 5.5],
  [3.58238887786865, 3.98366403579712],
  [3.67080092430115, -1.61512196063995],
  [0.0427630059421063, -3.49979686737061],
  [-3.0215744972229, -2.30188941955566],
  [-4.11523628234863, 2.8206672668457],
  [-2.25040984153748, 4.89687728881836],
  [2.24979114532471, 4.89723491668701],
  [4.49497747421265, 1.21254634857178],
  [2.83276462554932, -2.53633880615234],
  [-1.67862010002136, -3.17519283294678],
  [-4.37607145309448, -0.0488084554672241],
  [-3.24645185470581, 4.11617565155029],
  [-8.9391793967053e-10, 5.5],
  [3.95334625244141, 3.7363452911377],
  [3.67080092430115, -1.61512196063995],
  [-1.61876893043518, -3.19876027107239],
  [-3.31605863571167, -2.00849342346191],
  [-3.16644477844238, 4.19744110107422],
  [-0.000714155961759388, 5.5],
  [2.25, 4.89711427688599],
  [4.49497747421265, 1.21254634857178],
  [3.67080092430115, -1.61512196063995],
  [3.48499464988709, -1.85112416744232],
  [3.20942425727844, -2.10902380943298],
  [2.72343921661377, -2.69415378570557],
  [2.49080848693848, -3.54964542388916],
  [2.26180291175842, -4.72285890579224],
  [2.10494732856751, -5.6832160949707],
  [2, -7],
  [2.00009703636169, -7.99620056152344],
  [2, -7.5],
  [2.01568722724915, -8.3224458694458],
  [2.07941198348999, -8.76186180114746],
  [2.35070133209229, -9.60712337493897],
  [2.55460238456726, -10.0015525817871],
  [3.08735799789429, -10.7116470336914],
  [3.41330718994141, -11.0213689804077],
  [4.22182035446167, -11.5905742645264],
  [4.73658418655396, -11.8657369613647],
  [5.44400024414063, -12.1540288925171],
  [6.35738801956177, -12.3923625946045],
  [8.00286674499512, -12.5],
  [9.00285911560059, -12.5],
  [10.0028495788574, -12.5],
  [11.0028429031372, -12.5],
  [12.0028352737427, -12.5],
  [13.0028276443481, -12.5],
  [13.691951751709, -12.4876823425293],
  [14.5542488098145, -12.3638858795166],
  [15.2636852264404, -12.1564922332764],
  [15.767539024353, -11.9448852539063],
  [16.5723361968994, -11.4757356643677],
  [17.0047397613525, -11.1415576934814],
  [17.5347747802734, -10.6264152526855],
  [18.1003837585449, -9.88622283935547],
  [18.4581985473633, -9.23947715759277],
  [18.9328708648682, -7.6888484954834]
]
"""
)

PATH_ALT_WORLD = json.loads(
    """
[
  [3.95184111595154, 3.73728370666504],
  [3.67080092430115, -1.61512196063995],
  [-1.67862010002136, -3.17519283294678],
  [-3.26794672012329, -2.05340147018433],
  [-2.25041341781616, 4.89687538146973],
  [-0.000714155961759388, 5.5],
  [2.25, 4.89711427688599],
  [3.02043867111206, 4.40314340591431],
  [3.09220838546753, 4.34803628921509],
  [3.95096635818481, 3.73782920837402],
  [4.49752235412598, 3.43531584739685],
  [4.67571830749512, 3.35378408432007],
  [6.29659795761108, 2.95752334594727],
  [7.19551992416382, 2.78688025474548],
  [8.20610523223877, 2.62948083877563],
  [10, 2.5],
  [11, 2.5],
  [12.9999990463257, 2.5],
  [13.7593059539795, 2.54540085792542],
  [14.1944561004639, 2.61295032501221],
  [15.2347927093506, 2.90473484992981],
  [15.6416034698486, 3.07333183288574],
  [16.3137702941895, 3.42941808700562],
  [17.185697555542, 4.06752490997314],
  [17.634428024292, 4.49338722229004],
  [18.2386341094971, 5.17093944549561],
  [18.3936595916748, 5.4069128036499],
  [18.6838798522949, 5.994948387146],
  [18.9259643554688, 6.99362516403198],
  [18.8012580871582, 8.42976474761963],
  [18.6848964691162, 8.7900857925415],
  [18.2203197479248, 9.75075531005859],
  [18.010124206543, 10.0656976699829],
  [17.2670574188232, 10.9031744003296],
  [16.9667167663574, 11.1734848022461],
  [16.0822849273682, 11.782000541687],
  [15.7224798202515, 11.9658899307251],
  [14.7112140655518, 12.3262338638306],
  [14.3162002563477, 12.4113073348999],
  [13.220947265625, 12.4996480941772],
  [12.220947265625, 12.4996480941772],
  [11.220947265625, 12.4996480941772],
  [10.220947265625, 12.4996480941772],
  [9.220947265625, 12.4996480941772],
  [8.220947265625, 12.4996480941772],
  [7.220947265625, 12.4996480941772],
  [6.220947265625, 12.4996480941772],
  [5.220947265625, 12.4996480941772],
  [4.22095108032227, 12.4996480941772],
  [3.22095108032227, 12.4996480941772],
  [2.220947265625, 12.4996480941772],
  [1.22094917297363, 12.4996480941772],
  [0.220950126647949, 12.4996480941772],
  [-0.779052734375, 12.4996480941772],
  [-1.779052734375, 12.4996480941772],
  [-2.779052734375, 12.4996480941772],
  [-3.77905082702637, 12.4996480941772],
  [-4.77904891967773, 12.4996480941772],
  [-5.77905225753784, 12.4996480941772],
  [-6.77905035018921, 12.4996480941772],
  [-7.77904844284058, 12.4996480941772],
  [-8.779052734375, 12.4996480941772],
  [-9.77905082702637, 12.4996480941772],
  [-10.7790489196777, 12.4996480941772],
  [-11.779052734375, 12.4996480941772],
  [-12.7790470123291, 12.4996480941772],
  [-13.6588525772095, 12.4894256591797],
  [-14.0610799789429, 12.4508695602417],
  [-15.1073932647705, 12.2105855941772],
  [-15.4861431121826, 12.0697898864746],
  [-16.1495685577393, 11.7439365386963],
  [-17.0256385803223, 11.1234445571899],
  [-17.5881156921387, 10.5790328979492],
  [-17.8364677429199, 10.2932109832764],
  [-18.2509250640869, 9.70047473907471],
  [-18.801362991333, 8.42938899993897],
  [-18.9254055023193, 7.78547286987305],
  [-18.9461135864258, 7.35565567016602],
  [-18.8375663757324, 6.48175001144409],
  [-18.7123336791992, 6.07006072998047],
  [-18.4345302581787, 5.47605800628662],
  [-17.9095211029053, 4.76905107498169],
  [-17.3875617980957, 4.25112915039063],
  [-16.7132797241211, 3.69373345375061],
  [-16.2281188964844, 3.37818431854248],
  [-15.3824996948242, 2.96215486526489],
  [-14.8364505767822, 2.7703652381897],
  [-13, 2.5],
  [-12, 2.5],
  [-10, 2.5],
  [-8.99836921691895, 2.54372096061707],
  [-7.98893451690674, 2.6593177318573],
  [-6.97797298431397, 2.82612180709839],
  [-5.93238162994385, 3.03161287307739],
  [-4.97195911407471, 3.23696804046631],
  [-4.37453460693359, 3.49654340744019],
  [-3.84161710739136, 3.80752801895142],
  [-3.55907440185547, 4.00020313262939],
  [-2.25040984153748, 4.89687728881836],
  [2.24979114532471, 4.89723491668701],
  [4.49497747421265, 1.21254634857178],
  [2.83276462554932, -2.53633880615234],
  [-1.67862010002136, -3.17519283294678],
  [-4.37607145309448, -0.0488084554672241],
  [-3.24645185470581, 4.11617565155029],
  [-8.9391793967053e-10, 5.5],
  [3.95334625244141, 3.7363452911377],
  [3.67080092430115, -1.61512196063995],
  [-1.61876893043518, -3.19876027107239],
  [-3.31605863571167, -2.00849342346191],
  [-3.16644477844238, 4.19744110107422],
  [-0.000714155961759388, 5.5],
  [2.25, 4.89711427688599],
  [4.49497747421265, 1.21254634857178],
  [3.67080092430115, -1.61512196063995],
  [3.48499464988709, -1.85112416744232],
  [3.20942425727844, -2.10902380943298],
  [2.72343921661377, -2.69415378570557],
  [2.49080848693848, -3.54964542388916],
  [2.26180291175842, -4.72285890579224],
  [2.10494732856751, -5.6832160949707],
  [2, -7],
  [2.00009703636169, -7.99620056152344],
  [2, -7.5],
  [1.96876180171967, -8.6758337020874],
  [1.74131631851196, -9.98782634735107],
  [1.2995148897171, -11.2439565658569],
  [0.655583262443543, -12.409462928772],
  [-0.172657608985901, -13.4520893096924],
  [-1.15541696548462, -14.3379755020142],
  [-2.17831134796143, -15.0302276611328],
  [-3.27554273605347, -15.5973329544067],
  [-4.43187236785889, -16.0314159393311],
  [-5.6312403678894, -16.3264465332031],
  [-6.85698843002319, -16.478328704834],
  [-8, -16.5],
  [-8.99998092651367, -16.5],
  [-9.99996185302734, -16.5],
  [-10.999942779541, -16.5],
  [-11.9999237060547, -16.5],
  [-12.9999046325684, -16.5],
  [-14.1764249801636, -16.4618721008301],
  [-15.4210052490234, -16.2688503265381],
  [-16.6300010681152, -15.9159059524536],
  [-17.7829513549805, -15.4090099334717],
  [-18.8603496551514, -14.756742477417],
  [-19.8439617156982, -13.970139503479],
  [-20.7171459197998, -13.0625104904175],
  [-21.4651260375977, -12.0492153167725],
  [-22.0752429962158, -10.9474010467529],
  [-22.5371742248535, -9.77571105957031],
  [-22.8856143951416, -8.30189418792725]
]
"""
)

PATH_MAIN = normalize_route(PATH_MAIN_WORLD)
PATH_DETOUR = normalize_route(PATH_DETOUR_WORLD)
PATH_ALT = normalize_route(PATH_ALT_WORLD)

ROUTES = {
    "main": PATH_MAIN,
    "detour": PATH_DETOUR,
    "alt": PATH_ALT,
}

CAMERAS_ON_MAP = [
    {"id": "camMarker-1", "cameraId": "cam-1", "x": -0.01, "y": 0.50},
    {"id": "camMarker-2", "cameraId": "cam-2", "x": 0.25, "y": -0.01},
    {"id": "camMarker-3", "cameraId": "cam-3", "x": 0.75, "y": -0.01},
    {"id": "camMarker-4", "cameraId": "cam-4", "x": 1.01, "y": 0.50},
    {"id": "camMarker-5", "cameraId": "cam-5", "x": 0.75, "y": 1.01},
    {"id": "camMarker-6", "cameraId": "cam-6", "x": 0.25, "y": 1.01},
]

CAMERAS_STATUS = [
    {"id": "cam-1", "name": "Camera 1", "streamUrl": "/assets/map-track.png", "streamBEVUrl": "/assets/map-track.png"},
    {"id": "cam-2", "name": "Camera 2", "streamUrl": "/assets/map-track.png", "streamBEVUrl": "/assets/map-track.png"},
    {"id": "cam-3", "name": "Camera 3", "streamUrl": "/assets/map-track.png", "streamBEVUrl": "/assets/map-track.png"},
    {"id": "cam-4", "name": "Camera 4", "streamUrl": "/assets/map-track.png", "streamBEVUrl": "/assets/map-track.png"},
    {"id": "cam-5", "name": "Camera 5", "streamUrl": "/assets/map-track.png", "streamBEVUrl": "/assets/map-track.png"},
    {"id": "cam-6", "name": "Camera 6", "streamUrl": "/assets/map-track.png", "streamBEVUrl": "/assets/map-track.png"},
]

TRAFFIC_LIGHTS_RAW = [
    {"id": "tl-1", "trafficLightId": 1, "x": -5.4, "y": -13.4, "yaw": 90.0},
    {"id": "tl-2", "trafficLightId": 2, "x": 5.4, "y": -17.2, "yaw": -90.0},
    {"id": "tl-3", "trafficLightId": 3, "x": 2.0, "y": -9.9, "yaw": 0.0},
    {"id": "tl-4", "trafficLightId": 4, "x": -19.15, "y": 5.7, "yaw": 0.0},
    {"id": "tl-5", "trafficLightId": 5, "x": -23.0, "y": -6.3, "yaw": 180.0},
    {"id": "tl-6", "trafficLightId": 6, "x": -15.8, "y": -2.35, "yaw": -90.0},
    {"id": "tl-7", "trafficLightId": 7, "x": 19.1, "y": -6.2, "yaw": 180.0},
    {"id": "tl-8", "trafficLightId": 8, "x": 23.0, "y": 5.7, "yaw": 0.0},
    {"id": "tl-9", "trafficLightId": 9, "x": 15.7, "y": 2.0, "yaw": 90.0},
]

TRAFFIC_LIGHTS_ON_MAP: List[dict] = []
for item in TRAFFIC_LIGHTS_RAW:
    try:
        x_map, y_map = world_to_map_xy(float(item["x"]), -float(item["y"]))
        TRAFFIC_LIGHTS_ON_MAP.append(
            {
                "id": item["id"],
                "trafficLightId": int(item["trafficLightId"]),
                "x": x_map,
                "y": y_map,
                "yaw": float(item["yaw"]),
            }
        )
    except Exception:
        continue

CAR_DEFS = [
    {"car_id": "car-1", "color": "red", "phase": 0.0, "cameraIds": ["cam-1", "cam-2"], "route": "main"},
    {"car_id": "car-2", "color": "purple", "phase": 1.6, "cameraIds": ["cam-3"], "route": "alt"},
]

OBSTACLE_ID = "ob-1"
OBSTACLE_WORLD = (-3.24645185470581, 4.11617565155029)
OBSTACLE_POS = world_to_map_xy(OBSTACLE_WORLD[0], -OBSTACLE_WORLD[1])


def build_obstacle_upsert(ts: float) -> dict:
    return {
        "type": "obstacleStatus",
        "ts": ts,
        "data": {
            "mode": "delta",
            "upserts": [
                {"id": OBSTACLE_ID, "obstacleId": OBSTACLE_ID, "x": OBSTACLE_POS[0], "y": OBSTACLE_POS[1], "kind": "barricade"}
            ],
            "statusUpserts": [
                {"id": OBSTACLE_ID, "class": 2, "cameraIds": ["cam-2", "cam-3"]},
            ],
        },
    }


def build_obstacle_clear(ts: float) -> dict:
    return {
        "type": "obstacleStatus",
        "ts": ts,
        "data": {
            "mode": "delta",
            "deletes": [OBSTACLE_ID],
            "statusDeletes": [OBSTACLE_ID],
        },
    }


def build_route_change(ts: float, obstacle_active: bool) -> dict:
    route = PATH_DETOUR if obstacle_active else PATH_MAIN
    return {
        "type": "carRouteChange",
        "ts": ts,
        "data": {
            "changes": [
                {"carId": "car-1", "newRoute": route},
            ],
        },
    }


def build_car_message(ts: float, obstacle_active: bool) -> dict:
    cars_on_map: List[dict] = []
    cars_status: List[dict] = []

    for idx, car in enumerate(CAR_DEFS):
        route_key = car.get("route", "main")
        if route_key == "main" and obstacle_active:
            route_points = ROUTES["detour"]
            route_changed = True
        else:
            route_points = ROUTES.get(route_key, ROUTES["main"])
            route_changed = False

        x, y, yaw = sample_route(route_points, ts * 0.12 + car.get("phase", 0.0))
        map_status = "routeChanged" if route_changed else "normal"

        cars_on_map.append(
            {
                "id": f"m{car['car_id']}",
                "carId": car["car_id"],
                "x": x,
                "y": y,
                "yaw": yaw,
                "color": car["color"],
                "status": map_status,
            }
        )

        cars_status.append(
            {
                "car_id": car["car_id"],
                "color": car["color"],
                "class": 0,
                "speed": round(4.8 + idx * 0.6, 2),
                "battery": 95 - idx * 3,
                "cameraIds": car.get("cameraIds", []),
                "path_future": route_points,
                "category": "normal",
                "resolution": "plan",
                "routeChanged": route_changed,
            }
        )

    return {
        "type": "carStatus",
        "ts": ts,
        "data": {
            "mode": "snapshot",
            "carsOnMap": cars_on_map,
            "carsStatus": cars_status,
        },
    }


def build_traffic_light_message(ts: float, prev_status: Optional[List[dict]]) -> Tuple[Optional[dict], List[dict]]:
    colors = ["green", "yellow", "red"]
    phase = int(ts // 4)
    statuses: List[dict] = []
    for idx, tl in enumerate(TRAFFIC_LIGHTS_ON_MAP):
        color = colors[(phase + idx) % len(colors)]
        statuses.append(
            {
                "trafficLightId": tl["trafficLightId"],
                "light": color,
                "left_green": (color == "green" and idx % 2 == 0),
            }
        )

    if prev_status is None:
        return (
            {
                "type": "trafficLightStatus",
                "ts": ts,
                "data": {"mode": "snapshot", "trafficLightsOnMap": TRAFFIC_LIGHTS_ON_MAP, "trafficLightsStatus": statuses},
            },
            statuses,
        )

    if statuses != prev_status:
        return (
            {
                "type": "trafficLightStatus",
                "ts": ts,
                "data": {"mode": "delta", "trafficLightsStatusUpserts": statuses},
            },
            statuses,
        )
    return None, prev_status


async def handler(websocket):
    print("[ws_simulator] client connected")
    cam_status = {
        "type": "camStatus",
        "ts": time.time(),
        "data": {"camerasOnMap": CAMERAS_ON_MAP, "camerasStatus": CAMERAS_STATUS},
    }
    await websocket.send(json.dumps(cam_status))

    tl_msg, last_tl_status = build_traffic_light_message(time.time(), None)
    if tl_msg:
        await websocket.send(json.dumps(tl_msg))

    last_obstacle_active: Optional[bool] = None

    try:
        while True:
            ts = time.time()
            obstacle_active = (int(ts) // 10) % 2 == 0

            await websocket.send(json.dumps(build_car_message(ts, obstacle_active)))

            tl_delta, last_tl_status = build_traffic_light_message(ts, last_tl_status)
            if tl_delta:
                await websocket.send(json.dumps(tl_delta))

            if last_obstacle_active is None:
                if obstacle_active:
                    await websocket.send(json.dumps(build_obstacle_upsert(ts)))
                    await websocket.send(json.dumps(build_route_change(ts, True)))
                last_obstacle_active = obstacle_active
            elif obstacle_active != last_obstacle_active:
                if obstacle_active:
                    await websocket.send(json.dumps(build_obstacle_upsert(ts)))
                    await websocket.send(json.dumps(build_route_change(ts, True)))
                else:
                    await websocket.send(json.dumps(build_obstacle_clear(ts)))
                    await websocket.send(json.dumps(build_route_change(ts, False)))
                last_obstacle_active = obstacle_active

            await asyncio.sleep(0.25)
    except Exception as exc:
        print(f"[ws_simulator] client closed: {exc}")


async def main():
    async with websockets.serve(handler, HOST, PORT):
        print(f"[ws_simulator] ws://{HOST}:{PORT}/monitor")
        await asyncio.Future()


if __name__ == "__main__":
    asyncio.run(main())
